{% extends "base.html" %}
{% block content %}
<h2 style="margin-bottom:1rem;">Operations admin</h2>
{% if message %}
<div class="alert">{{ message }}</div>
{% endif %}
<div class="card">
    <h3 style="margin-top:0;">Feeds</h3>
    <p style="color:#475569;">Add or adjust tracked sources. Schedules shorter than 60 seconds are automatically rounded up.</p>
    <h4>Create new feed</h4>
    <form method="post" action="/admin/feeds">
        <div class="grid two">
            <div>
                <label for="feed-name">Name</label>
                <input id="feed-name" type="text" name="name" required placeholder="World Service" />
            </div>
            <div>
                <label for="feed-url">URL</label>
                <input id="feed-url" type="text" name="url" required placeholder="https://example.com/rss" />
            </div>
            <div>
                <label for="feed-schedule">Schedule (seconds)</label>
                <input id="feed-schedule" type="number" min="60" name="schedule_seconds" value="900" />
                <small>Polling cadence per feed.</small>
            </div>
            <div>
                <label>&nbsp;</label>
                <div>
                    <label><input type="checkbox" name="enabled" checked /> Enabled</label>
                </div>
            </div>
        </div>
        <button type="submit">Create feed</button>
    </form>
    <h4 style="margin-top:2rem;">Existing feeds</h4>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>URL</th>
                <th>Schedule</th>
                <th>Enabled</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for feed in feeds %}
            <tr>
                <td colspan="5">
                    <form method="post" action="/admin/feeds/{{ feed.id }}/update" style="width:100%;">
                        <div class="grid two">
                            <div>
                                <label>Name</label>
                                <input type="text" name="name" value="{{ feed.name }}" required />
                            </div>
                            <div>
                                <label>URL</label>
                                <input type="text" name="url" value="{{ feed.url }}" required />
                            </div>
                            <div>
                                <label>Schedule (seconds)</label>
                                <input type="number" name="schedule_seconds" value="{{ feed.schedule_seconds }}" min="60" />
                            </div>
                            <div>
                                <label>Enabled</label>
                                <input type="checkbox" name="enabled" {% if feed.enabled %}checked{% endif %} />
                            </div>
                        </div>
                        <button type="submit">Save</button>
                    </form>
                    <form method="post" action="/admin/feeds/{{ feed.id }}/delete" style="display:inline-block; margin-left:0.5rem;">
                        <button type="submit" class="secondary">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="5">No feeds configured.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="grid two">
    <div class="card">
        <h3 style="margin-top:0;">Summarisation cadence</h3>
        <p style="color:#475569;">The scheduler reloads configuration every 60 seconds without downtime.</p>
        <form method="post" action="/admin/settings/scheduler">
            <label for="interval">Interval (seconds)</label>
            <input id="interval" type="number" min="300" name="interval_seconds" value="{{ interval }}" />
            <small>Minimum 5 minutes recommended to allow ingestion batches.</small>
            <button type="submit" style="margin-top:0.75rem;">Update interval</button>
        </form>
    </div>
    <div class="card">
        <h3 style="margin-top:0;">Model configuration</h3>
        <p style="color:#475569;">Configure the Ollama runtime used for enrichment and summarisation.</p>
        <form method="post" action="/admin/settings/llm">
            <label for="provider">Provider</label>
            <input id="provider" type="text" name="provider" value="{{ provider }}" required />
            <label for="model-name">Model</label>
            <input id="model-name" type="text" name="model" value="{{ model }}" required />
            <label for="base-url">Base URL</label>
            <input id="base-url" type="text" name="base_url" value="{{ base_url }}" required />
            <small>Example: model <code>qwen3:30b</code> served by Ollama on <code>http://127.0.0.1:11434</code>.</small>
            <button type="submit" style="margin-top:0.75rem;">Save configuration</button>
        </form>
        <div class="llm-test-section">
            <div class="llm-test-actions">
                <button type="button" id="llm-test-button" class="secondary">Test connection</button>
                <span id="llm-test-status" class="status-indicator status-idle" role="status">Idle</span>
            </div>
            <div class="llm-test-log">
                <label for="llm-test-log" class="muted-label">Test output</label>
                <div id="llm-test-log" class="output-panel" aria-live="polite">No test run yet.</div>
            </div>
            <small>Runs a short probe asking the configured model to confirm it is reachable.</small>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-top:0;">Audience profile</h3>
    <p style="color:#475569;">Provide detailed guidance for the relevance critic. Minimum 40 characters.</p>
    <form method="post" action="/admin/profile">
        <label for="profile-title">Title</label>
        <input id="profile-title" type="text" name="title" value="{{ profile.title if profile else '' }}" placeholder="Executive Intelligence" />
        <label for="profile-content">Profile brief</label>
        <textarea id="profile-content" name="content" required>{{ profile.content if profile else '' }}</textarea>
        <small>Describe decision-makers, alert thresholds, and information priorities.</small>
        <button type="submit" style="margin-top:0.75rem;">Update profile</button>
    </form>
</div>
<script>
    (function () {
        const button = document.getElementById("llm-test-button");
        const statusLabel = document.getElementById("llm-test-status");
        const toastContainer = document.getElementById("toast-container");
        const logPanel = document.getElementById("llm-test-log");

        if (!button || !statusLabel) {
            return;
        }

        const stateClasses = {
            idle: "status-idle",
            running: "status-running",
            success: "status-success",
            error: "status-error",
        };

        const setStatus = (state, label) => {
            const stateClass = stateClasses[state] || stateClasses.idle;
            statusLabel.textContent = label;
            statusLabel.className = `status-indicator ${stateClass}`;
        };

        const timestamp = () => new Date().toISOString();

        const updateLog = (lines) => {
            if (!logPanel) {
                return;
            }
            const content = lines.join("\n");
            logPanel.textContent = content || "Awaiting log output.";
            logPanel.scrollTop = logPanel.scrollHeight;
        };

        const createLogger = () => {
            const lines = [];
            return {
                push: (...entries) => {
                    entries.forEach((entry) => {
                        if (Array.isArray(entry)) {
                            entry.forEach((item) => {
                                const parts = String(item).split(/\r?\n/);
                                parts.forEach((part) => lines.push(part));
                            });
                            return;
                        }
                        const parts = String(entry).split(/\r?\n/);
                        parts.forEach((part) => lines.push(part));
                    });
                    updateLog(lines);
                },
                lines,
            };
        };

        const showToast = (message, variant) => {
            if (!toastContainer) {
                return;
            }
            const toast = document.createElement("div");
            const tone = variant === "error" ? "toast-error" : "toast-success";
            toast.className = `toast ${tone}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            window.setTimeout(() => {
                toast.classList.add("toast-hide");
            }, 4500);
            window.setTimeout(() => {
                toast.remove();
            }, 5000);
        };

        button.addEventListener("click", async () => {
            button.disabled = true;
            setStatus("running", "Testing...");

            const logger = createLogger();
            logger.push(`[${timestamp()}] Starting LLM connectivity test.`);
            logger.push(`[${timestamp()}] Request: POST /admin/settings/llm/test`);

            try {
                const response = await fetch("/admin/settings/llm/test", {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                    },
                    credentials: "same-origin",
                });

                const statusLabelText = response.statusText ? `${response.status} ${response.statusText}` : `${response.status}`;
                logger.push(`[${timestamp()}] Response status: ${statusLabelText}`);

                const responseText = await response.text();
                if (responseText) {
                    logger.push("Response body:");
                    logger.push(responseText);
                } else {
                    logger.push("Response body: <empty>");
                }

                let payload = null;
                if (responseText) {
                    try {
                        payload = JSON.parse(responseText);
                    } catch (parseError) {
                        const parseMessage = parseError instanceof Error ? parseError.message : "Unparseable response";
                        logger.push(`JSON parse error: ${parseMessage}`);
                    }
                }

                if (!response.ok || !payload || payload.ok !== true) {
                    const reason = (payload && (payload.error || payload.detail || payload.message)) || statusLabelText || "Request failed";
                    setStatus("error", "Failed");
                    showToast(`LLM test failed: ${reason}`, "error");
                    logger.push(`[${timestamp()}] Test outcome: failed.`);
                    logger.push(`Reason: ${reason}`);
                    return;
                }

                setStatus("success", "Success");
                showToast(`LLM replied: ${payload.response}`, "success");
                logger.push(`[${timestamp()}] Test outcome: success.`);
                if (payload.response) {
                    logger.push(`Model response: ${payload.response}`);
                }
            } catch (error) {
                const message = error instanceof Error ? error.message : "Unexpected error";
                setStatus("error", "Failed");
                showToast(`LLM test failed: ${message}`, "error");
                logger.push(`[${timestamp()}] Test outcome: failed.`);
                logger.push(`Network error: ${message}`);
            } finally {
                window.setTimeout(() => {
                    setStatus("idle", "Idle");
                }, 5000);
                button.disabled = false;
            }
        });
    })();
</script>
{% endblock %}
